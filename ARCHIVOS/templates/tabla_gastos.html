<div class="card shadow-sm">
    <div class="card-header">
        <h5 class="mb-0 fw-bold"><i class="bi bi-funnel-fill me-2"></i>Filtros y Búsqueda</h5>
    </div>
    <div class="card-body">
        <!-- Formulario de Filtros con HTMX -->
        <form class="row g-3 align-items-end" 
              hx-get="{{ url_for('gastos.gestion_gastos') }}" 
              hx-target="#tabla-gastos-container" 
              hx-swap="outerHTML"
              hx-trigger="submit"
              hx-on="htmx:afterRequest: this.closest('body').dispatchEvent(new Event('reload-charts'))">
            <div class="col-md-4">
                <label for="fecha_inicio" class="form-label">Desde</label>
                <input type="date" class="form-control" id="fecha_inicio" name="fecha_inicio" value="{{ fecha_inicio or '' }}">
            </div>
            <div class="col-md-4">
                <label for="fecha_fin" class="form-label">Hasta</label>
                <input type="date" class="form-control" id="fecha_fin" name="fecha_fin" value="{{ fecha_fin or '' }}">
            </div>
            <div class="col-md-4">
                <label for="categoria" class="form-label">Categoría</label>
                <select class="form-select" id="categoria" name="categoria">
                    <option value="">Todas</option>
                    {% for cat_id, cat_name in categorias_gastos %}
                    <option value="{{ cat_id }}" {% if cat_id == categoria_filtro %}selected{% endif %}>{{ cat_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-12 d-flex justify-content-end gap-2">
                <a href="{{ url_for('gastos.gestion_gastos') }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-counterclockwise me-2"></i>Limpiar</a>
                <button type="submit" class="btn btn-primary"><i class="bi bi-search me-2"></i>Aplicar Filtros</button>
            </div>
        </form>
    </div>
    <div class="card-header border-top">
         <h5 class="mb-0 fw-bold"><i class="bi bi-list-ul me-2"></i>Historial de Gastos</h5>
    </div>
    <div class="table-responsive">
        {% set category_colors = {
            'SERVICIOS': 'bg-primary',
            'RENTA': 'bg-success',
            'PAPELERIA': 'bg-info',
            'SUELDOS': 'bg-warning text-dark',
            'MARKETING': 'bg-danger',
            'IMPUESTOS': 'bg-dark',
            'MANTENIMIENTO': 'bg-secondary',
            'OTROS': 'bg-light text-dark border'
        } %}
        <table class="table table-striped table-hover mb-0">
            <thead>
                <tr>
                    <th class="ps-3">Fecha</th>
                    <th>Proveedor</th>
                    <th>Categoría</th>
                    <th>Descripción</th>
                    <th class="text-end">Monto</th>
                    <th class="text-center pe-3">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for gasto in gastos %}
                <tr class="align-middle">
                    <td class="ps-3">{{ gasto.fecha.strftime('%d/%m/%Y') }}</td>
                    <td>{{ gasto.proveedor_nombre }}</td>
                    <td><span class="badge {{ category_colors.get(gasto.categoria, 'bg-light text-dark border') }}">{{ gasto.categoria }}</span></td>
                    <td class="small">{{ gasto.descripcion }}</td>
                    <td class="text-end fw-bold text-danger">${{ "%.2f"|format(gasto.monto) }}</td>
                    <td class="text-center pe-3">
                        <a href="{{ url_for('gastos.gestion_gastos', duplicar=gasto.id) }}" class="btn btn-sm btn-outline-info" title="Duplicar Gasto"><i class="bi bi-files"></i></a>
                        <a href="{{ url_for('gastos.editar_gasto', gasto_id=gasto.id) }}" class="btn btn-sm btn-outline-primary ms-1" title="Editar"><i class="bi bi-pencil-fill"></i></a>
                        {% if gasto.receipt_filename %}
                            <a href="{{ url_for('gastos.ver_recibo', filename=gasto.receipt_filename) }}" target="_blank" class="btn btn-sm btn-outline-secondary ms-1" title="Ver Recibo"><i class="bi bi-paperclip"></i></a>
                        {% endif %}
                        <form action="{{ url_for('gastos.eliminar_gasto', gasto_id=gasto.id) }}" method="post" class="d-inline" onsubmit="return confirm('¿Estás seguro de que quieres eliminar este gasto?');">
                            {{ delete_form.hidden_tag() }}
                            <button type="submit" class="btn btn-sm btn-outline-danger ms-1" title="Eliminar"><i class="bi bi-trash-fill"></i></button>
                        </form>                        
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center p-5">
                        <i class="bi bi-funnel display-4 text-muted"></i>
                        <h5 class="mt-3">No se encontraron gastos</h5>
                        <p class="text-muted">No hay gastos que coincidan con los filtros seleccionados. Intenta cambiarlos o registra un nuevo gasto.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Paginación con HTMX -->
    {% if total_pages > 1 %}
    <div class="card-footer d-flex justify-content-center">
        <nav>
            <ul class="pagination mb-0">
                <li class="page-item {% if current_page == 1 %}disabled{% endif %}"><a class="page-link" hx-get="{{ url_for('gastos.gestion_gastos', page=current_page - 1, fecha_inicio=fecha_inicio, fecha_fin=fecha_fin, categoria=categoria_filtro) }}" hx-target="#tabla-gastos-container" hx-swap="outerHTML"><i class="bi bi-chevron-left"></i></a></li>
                {% for page_num in range(1, total_pages + 1) %}
                <li class="page-item {% if page_num == current_page %}active{% endif %}">
                    <a class="page-link" hx-get="{{ url_for('gastos.gestion_gastos', page=page_num, fecha_inicio=fecha_inicio, fecha_fin=fecha_fin, categoria=categoria_filtro) }}" hx-target="#tabla-gastos-container" hx-swap="outerHTML">{{ page_num }}</a>
                </li>
                {% endfor %}
                <li class="page-item {% if current_page == total_pages %}disabled{% endif %}"><a class="page-link" hx-get="{{ url_for('gastos.gestion_gastos', page=current_page + 1, fecha_inicio=fecha_inicio, fecha_fin=fecha_fin, categoria=categoria_filtro) }}" hx-target="#tabla-gastos-container" hx-swap="outerHTML"><i class="bi bi-chevron-right"></i></a></li>
            </ul>
        </nav>
    </div>
    {% endif %}
</div>