<!-- Selector de Papelería -->
<div class="mb-3">
    <label class="form-label d-flex align-items-center gap-2">
        <i class="bi bi-shop text-primary"></i>
        {{ form_tramite.papeleria_id.label.text }}
    </label>
    <div class="select-wrapper">
        {{ form_tramite.papeleria_id(class="form-select form-select-modern" + (" is-invalid" if form_tramite.papeleria_id.errors else ""), id="papeleria") }}
    </div>
    {% for error in form_tramite.papeleria_id.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
</div>

<!-- Selector de Trámite -->
<div class="mb-3">
    <label class="form-label d-flex align-items-center gap-2">
        <i class="bi bi-file-earmark-text text-primary"></i>
        {{ form_tramite.tramite.label.text }}
    </label>
    <div class="select-wrapper">
        {{ form_tramite.tramite(class="form-select form-select-modern" + (" is-invalid" if form_tramite.tramite.errors else ""), id="tramite") }}
    </div>
    {% for error in form_tramite.tramite.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
</div>

<!-- Campo manual para trámite personalizado -->
<div class="mb-3" id="tramiteManualContainer" style="display: none;">
    <label class="form-label d-flex align-items-center gap-2">
        <i class="bi bi-pencil text-warning"></i>
        {{ form_tramite.tramite_manual.label.text }}
    </label>
    {{ form_tramite.tramite_manual(class="form-control form-control-modern" + (" is-invalid" if form_tramite.tramite_manual.errors else ""), placeholder="Escribe el nombre del trámite personalizado") }}
    {% for error in form_tramite.tramite_manual.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
</div>

<!-- Precio y Costo -->
<div class="row g-3">
    <div class="col-6">
        <label class="form-label d-flex align-items-center gap-2">
            <i class="bi bi-currency-dollar text-success"></i>
            {{ form_tramite.precio.label.text }}
        </label>
        <div class="input-group input-group-modern">
            <span class="input-group-text">$</span>
            {{ form_tramite.precio(class="form-control" + (" is-invalid" if form_tramite.precio.errors else ""), step="0.01", id="precio", placeholder="0.00") }}
        </div>
        <small class="text-muted d-block mt-1"><i class="bi bi-magic"></i> Auto-completado</small>
        {% for error in form_tramite.precio.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
    </div>
    <div class="col-6">
        <label class="form-label d-flex align-items-center gap-2">
            <i class="bi bi-cash-stack text-danger"></i>
            {{ form_tramite.costo.label.text }}
        </label>
        <div class="input-group input-group-modern">
            <span class="input-group-text">$</span>
            {{ form_tramite.costo(class="form-control" + (" is-invalid" if form_tramite.costo.errors else ""), step="0.01", id="costo", placeholder="0.00") }}
        </div>
        <small class="text-muted d-block mt-1"><i class="bi bi-magic"></i> Auto-completado</small>
        {% for error in form_tramite.costo.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
    </div>
</div>

<!-- Cantidad y Fecha -->
<div class="row g-3 mt-1">
    <div class="col-md-6 mb-3">
        <label for="cantidad" class="form-label d-flex align-items-center gap-2">
            <i class="bi bi-layers text-info"></i>
            {{ form_tramite.cantidad.label.text }}
            <i class="bi bi-question-circle text-muted small" tabindex="0" data-bs-toggle="tooltip" title="Cantidad de trámites iguales a registrar"></i>
        </label>
        <div class="cantidad-stepper">
            <button type="button" class="stepper-btn stepper-minus" onclick="stepCantidad(-1)">
                <i class="bi bi-dash-lg"></i>
            </button>
            <input type="number" id="cantidad" name="cantidad" min="1" step="1" 
                   class="stepper-input" 
                   value="{{ form_tramite.cantidad.data or 1 }}" 
                   onfocus="this.select()" 
                   onblur="validateCantidadOnBlur()" 
                   onwheel="wheelCantidad(event)">
            <button type="button" class="stepper-btn stepper-plus" onclick="stepCantidad(1)">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>
        {% for error in form_tramite.cantidad.errors %}<div class="invalid-feedback d-block text-center">{{ error }}</div>{% endfor %}
        <script>
        function stepCantidad(delta) {
            var input = document.getElementById('cantidad');
            var val = parseInt(input.value) || 1;
            val += delta;
            if (val < 1) val = 1;
            input.value = val;
            // Animación de feedback
            input.classList.add('stepper-bounce');
            setTimeout(() => input.classList.remove('stepper-bounce'), 150);
            input.dispatchEvent(new Event('input'));
        }
        function validateCantidadInput() {
            // Solo validar al perder foco
        }
        function validateCantidadOnBlur() {
            var input = document.getElementById('cantidad');
            var val = parseInt(input.value);
            if (isNaN(val) || val < 1) {
                input.value = 1;
            }
        }
        function wheelCantidad(e) {
            e.preventDefault();
            stepCantidad(e.deltaY < 0 ? 1 : -1);
        }
        // Soporte touch para deslizar arriba/abajo
        let touchStartY = null;
        function touchCantidadStart(e) {
            if (e.touches && e.touches.length === 1) {
                touchStartY = e.touches[0].clientY;
            }
        }
        function touchCantidadMove(e) {
            if (touchStartY !== null && e.touches && e.touches.length === 1) {
                let deltaY = e.touches[0].clientY - touchStartY;
                if (Math.abs(deltaY) > 20) {
                    stepCantidad(deltaY < 0 ? 1 : -1);
                    touchStartY = e.touches[0].clientY;
                }
            }
        }
        </script>
    </div>
    <div class="col-md-6 mb-3">
        <label class="form-label d-flex align-items-center gap-2">
            <i class="bi bi-calendar3 text-secondary"></i>
            {{ form_tramite.fecha.label.text }}
        </label>
        {{ form_tramite.fecha(class="form-control form-control-modern" + (" is-invalid" if form_tramite.fecha.errors else "")) }}
        {% for error in form_tramite.fecha.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
    </div>
</div>

<!-- Estilos del formulario mejorado -->
<style>
/* Selectores modernos */
.form-select-modern, .form-control-modern {
    border-radius: 10px;
    border: 1.5px solid var(--bs-border-color);
    padding: 0.6rem 1rem;
    transition: all 0.2s ease;
    background-color: var(--bs-body-bg);
}
.form-select-modern:focus, .form-control-modern:focus {
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.12);
}
.form-select-modern:hover, .form-control-modern:hover {
    border-color: var(--bs-primary);
}

/* Input groups modernos */
.input-group-modern {
    border-radius: 10px;
    overflow: hidden;
}
.input-group-modern .input-group-text {
    background: var(--bs-tertiary-bg);
    border: 1.5px solid var(--bs-border-color);
    border-right: none;
    font-weight: 600;
    color: var(--bs-secondary-color);
}
.input-group-modern .form-control {
    border: 1.5px solid var(--bs-border-color);
    border-left: none;
    border-radius: 0 10px 10px 0 !important;
}
.input-group-modern .form-control:focus {
    box-shadow: none;
    border-color: var(--bs-primary);
}
.input-group-modern:focus-within {
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.12);
}
.input-group-modern:focus-within .input-group-text {
    border-color: var(--bs-primary);
}

/* Stepper de cantidad moderno */
.cantidad-stepper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    max-width: 200px;
    margin: 0 auto;
}
.stepper-btn {
    width: 48px;
    height: 48px;
    border-radius: 14px;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    cursor: pointer;
    transition: all 0.15s ease;
}
.stepper-minus {
    background: linear-gradient(135deg, #fee2e2, #fecaca);
    color: #dc2626;
}
.stepper-minus:hover {
    background: linear-gradient(135deg, #fecaca, #fca5a5);
    transform: scale(1.05);
}
.stepper-minus:active {
    transform: scale(0.95);
}
.stepper-plus {
    background: linear-gradient(135deg, #dcfce7, #bbf7d0);
    color: #16a34a;
}
.stepper-plus:hover {
    background: linear-gradient(135deg, #bbf7d0, #86efac);
    transform: scale(1.05);
}
.stepper-plus:active {
    transform: scale(0.95);
}
.stepper-input {
    width: 80px;
    height: 56px;
    border: 2px solid var(--bs-border-color);
    border-radius: 16px;
    text-align: center;
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--bs-body-color);
    background: var(--bs-body-bg);
    transition: all 0.15s ease;
    -moz-appearance: textfield;
}
.stepper-input::-webkit-outer-spin-button,
.stepper-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
.stepper-input:focus {
    outline: none;
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
}
.stepper-bounce {
    animation: stepperBounce 0.15s ease;
}
@keyframes stepperBounce {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.08); }
}

/* Dark mode adjustments */
[data-bs-theme="dark"] .stepper-minus {
    background: linear-gradient(135deg, rgba(220, 38, 38, 0.2), rgba(220, 38, 38, 0.15));
    color: #f87171;
}
[data-bs-theme="dark"] .stepper-minus:hover {
    background: linear-gradient(135deg, rgba(220, 38, 38, 0.3), rgba(220, 38, 38, 0.25));
}
[data-bs-theme="dark"] .stepper-plus {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.15));
    color: #4ade80;
}
[data-bs-theme="dark"] .stepper-plus:hover {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(34, 197, 94, 0.25));
}
</style>