<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Gr√°fico de Papeler√≠a</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .chart-container {
            position: relative;
            height: 30vh;
            min-height: 250px;
            width: 100%;
            max-width: 900px;
            margin: 20px auto;
            border: 2px solid #ccc;
            background: #f5f5f5;
        }
        .info { max-width: 900px; margin: 0 auto; }
    </style>
</head>
<body>
    <h1>Test - Gr√°fico Evoluci√≥n Mensual</h1>
    
    <div class="info">
        <h3>Datos de prueba (Papeler√≠a ID 84):</h3>
        <ul>
            <li>Ingreso Total: $600.00</li>
            <li>Gasto Total: $150.00</li>
            <li>Ganancia Neta: $450.00</li>
        </ul>
    </div>

    <div class="chart-container">
        <canvas id="clientMonthlyChart"></canvas>
    </div>

    <div id="logs" style="max-width: 900px; margin: 20px auto; padding: 10px; background: #f0f0f0; font-family: monospace; font-size: 12px;"></div>

    <script>
        const log = (msg) => {
            console.log(msg);
            document.getElementById('logs').innerHTML += msg + '<br>';
        };

        log('üöÄ Iniciando test...');
        log('Chart.js version: ' + Chart.version);
        log('ChartDataLabels disponible: ' + (typeof ChartDataLabels !== 'undefined'));

        // Datos simulados del endpoint
        const chart = {
            "labels": ["2025-01", "2025-02", "2025-03", "2025-04", "2025-05", "2025-06", 
                       "2025-07", "2025-08", "2025-09", "2025-10", "2025-11", "2025-12"],
            "ingresos": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 600.0],
            "costos": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 150.0],
            "ganancias": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 450.0],
            "totals": {
                "total_ingresos": 600.0,
                "total_gastos": 150.0,
                "total_ganancia": 450.0
            }
        };

        log('Datos cargados: ' + JSON.stringify(chart.totals));

        const canvas = document.getElementById('clientMonthlyChart');
        log('Canvas encontrado: ' + !!canvas);
        log('Canvas dimensions: ' + canvas.clientWidth + ' x ' + canvas.clientHeight);

        const ctx = canvas.getContext('2d');
        const fmt = (v) => new Intl.NumberFormat('es-MX', {style: 'currency', currency: 'MXN'}).format(v);

        const gains = chart.ganancias;
        const UX = { ganancias: '#22c55e', ingresos: '#3b82f6', gastos: '#ef4444' };

        log('Creando gr√°fico...');

        try {
            const myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chart.labels,
                    datasets: [
                        {
                            label: 'üí∞ Ganancia',
                            data: gains,
                            borderColor: UX.ganancias,
                            backgroundColor: 'rgba(34,197,94,0.3)',
                            borderWidth: 3,
                            tension: 0.35,
                            fill: true
                        },
                        {
                            label: 'üíµ Ingresos',
                            data: chart.ingresos,
                            borderColor: UX.ingresos,
                            borderWidth: 2,
                            tension: 0.35
                        },
                        {
                            label: 'üí∏ Costos',
                            data: chart.costos,
                            borderColor: UX.gastos,
                            borderWidth: 2,
                            tension: 0.35
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'üìà EVOLUCI√ìN MENSUAL (TEST)',
                            font: { size: 16, weight: '700' }
                        },
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { callback: (v) => fmt(v) }
                        },
                        x: {}
                    }
                }
            });

            log('‚úÖ Gr√°fico creado exitosamente!');
            log('Chart object: ' + typeof myChart);
        } catch (error) {
            log('‚ùå ERROR al crear gr√°fico: ' + error.message);
            log('Stack: ' + error.stack);
        }
    </script>
</body>
</html>
