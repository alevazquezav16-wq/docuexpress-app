<!-- Filtros de Rango Temporal -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-center justify-content-md-end align-items-center flex-wrap gap-2">
            <div class="btn-group w-100 w-md-auto" role="group" aria-label="Filtro de rango">
                <input type="radio" class="btn-check" name="dateRange" id="range7d" value="7" autocomplete="off">
                <label class="btn btn-outline-primary btn-sm" for="range7d">
                    <i class="bi bi-calendar-week me-1 d-none d-md-inline"></i><span class="d-md-none">7d</span><span class="d-none d-md-inline">7 d칤as</span>
                </label>
                <input type="radio" class="btn-check" name="dateRange" id="range30d" value="30" autocomplete="off" checked>
                <label class="btn btn-outline-primary btn-sm" for="range30d">
                    <i class="bi bi-calendar-month me-1 d-none d-md-inline"></i><span class="d-md-none">30d</span><span class="d-none d-md-inline">30 d칤as</span>
                </label>
                <input type="radio" class="btn-check" name="dateRange" id="range90d" value="90" autocomplete="off">
                <label class="btn btn-outline-primary btn-sm" for="range90d">
                    <i class="bi bi-calendar3 me-1 d-none d-md-inline"></i><span class="d-md-none">90d</span><span class="d-none d-md-inline">90 d칤as</span>
                </label>
                <input type="radio" class="btn-check" name="dateRange" id="rangeYear" value="365" autocomplete="off">
                <label class="btn btn-outline-primary btn-sm" for="rangeYear">
                    <i class="bi bi-calendar-range me-1 d-none d-md-inline"></i><span class="d-md-none">1a</span><span class="d-none d-md-inline">A침o</span>
                </label>
                <input type="radio" class="btn-check" name="dateRange" id="rangeCustom" value="custom" autocomplete="off">
                <label class="btn btn-outline-primary btn-sm" for="rangeCustom">
                    <i class="bi bi-sliders me-1"></i><span class="d-none d-sm-inline">Personalizado</span><span class="d-sm-none">+</span>
                </label>
            </div>
        </div>
        <!-- Resumen visual del rango seleccionado -->
        <div class="text-center mt-2">
            <span class="badge bg-info text-dark" id="dashboard-date-range-summary" style="font-size:1rem;">
                Mostrando datos del <span id="dashboard-date-range-start">-</span> al <span id="dashboard-date-range-end">-</span>
            </span>
        </div>
        <!-- Panel de Rango Personalizado (oculto por defecto) -->
        <div id="customRangePanel" class="mt-3" style="display: none;">
            <div class="card border-primary">
                <div class="card-body p-3">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="customStartDate" class="form-label small mb-1">Fecha Inicio</label>
                            <input type="date" class="form-control form-control-sm" id="customStartDate">
                        </div>
                        <div class="col-md-4">
                            <label for="customEndDate" class="form-label small mb-1">Fecha Fin</label>
                            <input type="date" class="form-control form-control-sm" id="customEndDate">
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-primary btn-sm w-100" id="applyCustomRange">
                                <i class="bi bi-check-circle me-1"></i>Aplicar Filtro
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
// Actualiza el resumen visual del rango de fechas seleccionado en el dashboard
function updateDashboardDateRangeSummary() {
    let start = '-';
    let end = '-';
    if (typeof getStartDate === 'function' && typeof getEndDate === 'function') {
        start = getStartDate();
        end = getEndDate();
    }
    document.getElementById('dashboard-date-range-start').textContent = start;
    document.getElementById('dashboard-date-range-end').textContent = end;
}

// Actualiza las tarjetas de resumen del dashboard seg칰n el filtro de fechas
async function updateDashboardTotals() {
    let fecha_inicio = typeof getStartDate === 'function' ? getStartDate() : null;
    let fecha_fin = typeof getEndDate === 'function' ? getEndDate() : null;
    try {
        const params = new URLSearchParams();
        if (fecha_inicio) params.append('fecha_inicio', fecha_inicio);
        if (fecha_fin) params.append('fecha_fin', fecha_fin);
        const res = await fetch('/api/dashboard-totals?' + params.toString(), {cache: 'no-store'});
        if (!res.ok) throw new Error('Error al obtener totales');
        const data = await res.json();
        // Actualizar tarjetas con IDs espec칤ficos para mayor confiabilidad
        const gananciaEl = document.getElementById('metric-ganancia');
        if (gananciaEl) gananciaEl.textContent = `$${parseFloat(data.ganancia).toFixed(2)}`;
        const tramitesHoyEl = document.getElementById('metric-tramites-hoy');
        if (tramitesHoyEl) tramitesHoyEl.textContent = data.tramites_de_hoy;
        const papeleriasEl = document.getElementById('metric-papelerias');
        if (papeleriasEl) papeleriasEl.textContent = data.num_papelerias;
        const gastosEl = document.getElementById('metric-gastos');
        if (gastosEl) gastosEl.textContent = `$${parseFloat(data.total_gastos_operativos).toFixed(2)}`;
        // Actualizar ganancia promedio
        const gananciaPromedioEl = document.getElementById('metric-ganancia-promedio');
        if (gananciaPromedioEl) gananciaPromedioEl.textContent = `${parseFloat(data.ganancia_promedio).toFixed(2)}$`;
    } catch (e) {
        console.error('No se pudieron actualizar los totales del dashboard:', e);
    }
}

function triggerDashboardTotalsUpdate() {
    updateDashboardDateRangeSummary();
    updateDashboardTotals();
    if (typeof chartManager !== 'undefined' && chartManager.initialize) {
        chartDataCache && chartDataCache.clear && chartDataCache.clear();
        chartManager.initialize();
    } else if (typeof initializeDashboardScripts === 'function') {
        initializeDashboardScripts();
    }
}

document.addEventListener('DOMContentLoaded', triggerDashboardTotalsUpdate);
document.body.addEventListener('change', function(event) {
    if (event.target.name === 'dateRange') {
        setTimeout(triggerDashboardTotalsUpdate, 150);
    }
});
document.body.addEventListener('click', function(event) {
    if (event.target.id === 'applyCustomRange' || (event.target.closest && event.target.closest('#applyCustomRange'))) {
        setTimeout(triggerDashboardTotalsUpdate, 250);
    }
});
</script>

<!-- Fila de Tarjetas de Resumen Redise침adas con Tendencias -->
{% if current_user.role == 'admin' %}
<div class="row g-4 mb-4" id="dashboard-cards">
    <!-- Tarjeta Ganancia Total -->
    <div class="col-lg-3 col-md-6">
        <div class="metric-card {% if totales.ganancia > 0 %}positive{% elif totales.ganancia < 0 %}negative{% endif %}">
            <div class="icon"><i class="bi bi-cash-coin"></i></div>
            <div class="content">
                <div class="label">Ganancia del Mes</div>
                <div class="value" id="metric-ganancia" data-target="{{ "%.2f"|format(totales.ganancia) }}">${{ "%.2f"|format(totales.ganancia) }}</div>
                {% if totales_comparativa %}
                <div class="trend {{ 'trend-up' if totales_comparativa.cambio_ganancia > 0 else 'trend-down' if totales_comparativa.cambio_ganancia < 0 else 'trend-neutral' }}">
                    <i class="bi {{ 'bi-arrow-up' if totales_comparativa.cambio_ganancia > 0 else 'bi-arrow-down' if totales_comparativa.cambio_ganancia < 0 else 'bi-dash' }}"></i>
                    <span>{{ "%.1f"|format(totales_comparativa.porcentaje_ganancia|abs) }}%</span>
                    <small class="trend-label">vs mes anterior</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Tarjeta Tr치mites de Hoy -->
    <div class="col-lg-3 col-md-6">
        <div class="metric-card">
            <div class="icon"><i class="bi bi-file-earmark-text"></i></div>
            <div class="content">
                <div class="label">Tr치mites de Hoy</div>
                <div class="value" id="metric-tramites-hoy" data-target="{{ tramites_de_hoy }}">{{ tramites_de_hoy }}</div>
                {% if tramites_comparativa %}
                <div class="trend {{ 'trend-up' if tramites_comparativa.cambio > 0 else 'trend-down' if tramites_comparativa.cambio < 0 else 'trend-neutral' }}">
                    <i class="bi {{ 'bi-arrow-up' if tramites_comparativa.cambio > 0 else 'bi-arrow-down' if tramites_comparativa.cambio < 0 else 'bi-dash' }}"></i>
                    <span>{{ tramites_comparativa.cambio|abs }} tr치mites</span>
                    <small class="trend-label">vs ayer</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Tarjeta Papeler칤as -->
    <div class="col-lg-3 col-md-6">
        <div class="metric-card">
            <div class="icon"><i class="bi bi-shop"></i></div>
            <div class="content">
                <div class="label">Papeler칤as Activas</div>
                <div class="value" id="metric-papelerias" data-target="{{ num_papelerias }}">{{ num_papelerias }}</div>
                <div class="trend trend-info">
                    <i class="bi bi-info-circle"></i>
                    <span id="metric-ganancia-promedio">{{ (totales.ganancia / num_papelerias)|round(2) if num_papelerias > 0 else 0 }}$</span>
                    <small class="trend-label">ganancia promedio</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tarjeta Gastos Operativos -->
    <div class="col-lg-3 col-md-6">
        <div class="metric-card negative">
             <div class="icon"><i class="bi bi-receipt"></i></div>
             <div class="content">
                <div class="label">Gastos del Mes</div>
                <div class="value" id="metric-gastos" data-target="{{ "%.2f"|format(total_gastos_operativos) }}">${{ "%.2f"|format(total_gastos_operativos) }}</div>
                {% if totales_comparativa %}
                <div class="trend {{ 'trend-down' if totales_comparativa.costos_porcentaje > 0 else 'trend-up' if totales_comparativa.costos_porcentaje < 0 else 'trend-neutral' }}">
                    <i class="bi {{ 'bi-arrow-up' if totales_comparativa.costos_porcentaje > 0 else 'bi-arrow-down' if totales_comparativa.costos_porcentaje < 0 else 'bi-dash' }}"></i>
                    <span>{{ "%.1f"|format(totales_comparativa.costos_porcentaje|abs) }}%</span>
                    <small class="trend-label">vs mes anterior</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Widget de Meta Mensual y Proyecci칩n -->
{% if current_user.role == 'admin' and meta_progress %}
<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5 class="mb-1 fw-bold">
                            <i class="bi bi-bullseye text-primary me-2"></i>
                            Meta Mensual
                        </h5>
                        <small class="text-muted">Objetivo: ${{ "{:,.2f}".format(meta_progress.meta_objetivo) }}</small>
                    </div>
                    <div class="text-end">
                        <div class="badge bg-primary fs-6 px-3 py-2">
                            {{ "%.1f"|format(meta_progress.porcentaje) }}%
                        </div>
                    </div>
                </div>
                
                <!-- Barra de progreso -->
                <div class="progress mb-3" style="height: 30px;">
                    <div class="progress-bar bg-gradient progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         style="width: {{ [meta_progress.porcentaje, 100]|min }}%"
                         aria-valuenow="{{ meta_progress.porcentaje }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        <span class="fw-bold">${{ "{:,.2f}".format(meta_progress.ganancia_actual) }}</span>
                    </div>
                </div>
                
                <!-- Informaci칩n detallada -->
                <div class="row g-3 text-center">
                    <div class="col-md-3">
                        <div class="p-2">
                            <i class="bi bi-cash-stack text-success fs-4"></i>
                            <div class="fw-bold mt-1">${{ "{:,.2f}".format(meta_progress.ganancia_actual) }}</div>
                            <small class="text-muted">Alcanzado</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-2">
                            <i class="bi bi-graph-up-arrow text-info fs-4"></i>
                            <div class="fw-bold mt-1">${{ "{:,.2f}".format(meta_progress.proyeccion) }}</div>
                            <small class="text-muted">Proyecci칩n</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-2">
                            <i class="bi bi-calendar-minus text-warning fs-4"></i>
                            <div class="fw-bold mt-1">{{ meta_progress.dias_restantes }}</div>
                            <small class="text-muted">D칤as hasta corte</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-2">
                            <i class="bi bi-flag text-danger fs-4"></i>
                            <div class="fw-bold mt-1">${{ "{:,.2f}".format(meta_progress.falta) }}</div>
                            <small class="text-muted">Falta</small>
                        </div>
                    </div>
                </div>
                
                <!-- Mensaje motivacional -->
                {% if meta_progress.proyeccion >= meta_progress.meta_objetivo %}
                <div class="alert alert-success mt-3 mb-0" role="alert">
                    <i class="bi bi-trophy-fill me-2"></i>
                    <strong>춰Excelente!</strong> Al ritmo actual alcanzar치s tu meta este mes. 춰Sigue as칤 hasta el corte del domingo!
                </div>
                {% elif meta_progress.porcentaje >= 75 %}
                <div class="alert alert-info mt-3 mb-0" role="alert">
                    <i class="bi bi-speedometer2 me-2"></i>
                    <strong>춰Buen ritmo!</strong> Faltan {{ meta_progress.dias_restantes }} d칤as hasta el corte del domingo. Necesitas ${{ "{:,.2f}".format(meta_progress.falta) }} m치s para la meta.
                </div>
                {% else %}
                <div class="alert alert-warning mt-3 mb-0" role="alert">
                    <i class="bi bi-rocket-takeoff me-2"></i>
                    <strong>춰Acelera!</strong> Quedan {{ meta_progress.dias_restantes }} d칤as hasta el domingo. Necesitas aumentar el ritmo para alcanzar tu meta de ${{ "{:,.2f}".format(meta_progress.meta_objetivo) }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Panel de M칠tricas Destacadas -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm" style="height: auto;">
            <div class="card-body p-4">
                <h6 class="fw-bold mb-3">
                    <i class="bi bi-star-fill text-warning me-2"></i>
                    M칠tricas Destacadas
                </h6>
                
                {% if mejor_mes %}
                <div class="mb-3 pb-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">游끥 Mejor Mes Hist칩rico</small>
                            <div class="fw-bold">{{ mejor_mes.mes }}</div>
                        </div>
                        <div class="text-end">
                            <div class="text-success fw-bold">${{ "{:,.0f}".format(mejor_mes.ganancia) }}</div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if dia_productivo %}
                <div class="mb-3 pb-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">游늰 D칤a M치s Productivo</small>
                            <div class="fw-bold">{{ dia_productivo.dia_nombre }}</div>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">{{ dia_productivo.tramites }} tr치mites</small>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="mb-3 pb-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">游늵 Margen Promedio</small>
                            <div class="fw-bold">{{ margen_promedio }}%</div>
                        </div>
                        <div class="text-end">
                            <div class="badge {{ 'bg-success' if margen_promedio >= 50 else 'bg-warning' }}">
                                {{ 'Excelente' if margen_promedio >= 50 else 'Bueno' if margen_promedio >= 30 else 'Mejorable' }}
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if rentabilidad_tramites and rentabilidad_tramites|length > 0 %}
                <div>
                    <small class="text-muted">游눯 Tr치mite M치s Rentable</small>
                    <div class="fw-bold">{{ rentabilidad_tramites[0].tramite }}</div>
                    <small class="text-success">+${{ "{:,.2f}".format(rentabilidad_tramites[0].margen_promedio) }} promedio</small>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Calculadora R치pida (debajo de m칠tricas destacadas) -->
        <div class="card border-0 shadow-sm mt-3">
            <div class="card-body p-4">
                <h6 class="fw-bold mb-3">
                    <i class="bi bi-calculator-fill text-primary me-2"></i>
                    Calculadora R치pida
                </h6>
                <p class="text-muted small mb-3">Estima tu ganancia potencial</p>
                
                <div class="row g-2">
                    <div class="col-12">
                        <label for="calcTramites" class="form-label small mb-1">Cantidad de tr치mites</label>
                        <input type="number" class="form-control form-control-sm" id="calcTramites" min="1" value="10" placeholder="Ej: 10">
                    </div>
                    <div class="col-12">
                        <label for="calcGanancia" class="form-label small mb-1">Ganancia promedio por tr치mite</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="calcGanancia" min="0" step="0.01" value="{{ margen_promedio|default(50)|round(2) }}" placeholder="Ej: 50.00">
                        </div>
                    </div>
                    <div class="col-12">
                        <button type="button" class="btn btn-primary btn-sm w-100 mt-2" id="btnCalcular">
                            <i class="bi bi-calculator me-1"></i> Calcular
                        </button>
                    </div>
                </div>
                
                <div id="calcResult" class="mt-3 p-3 rounded" style="background-color: var(--card-header-bg); display: none;">
                    <div class="text-center">
                        <small class="text-muted d-block mb-1">Ganancia estimada</small>
                        <div class="display-6 fw-bold text-success mb-2" id="calcTotal">$0.00</div>
                        <small class="text-muted" id="calcDetails"></small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Alertas Inteligentes y Insights -->
{% if current_user.role == 'admin' %}
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-lightbulb-fill text-warning fs-4 me-2"></i>
                    <h5 class="mb-0 fw-bold">Insights y Alertas</h5>
                </div>
                <div class="row g-3">
                    <!-- Alerta de gastos altos -->
                    {% if totales_comparativa and totales_comparativa.costos_porcentaje > 20 %}
                    <div class="col-md-6">
                        <div class="alert alert-warning mb-0 d-flex align-items-center" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <div>
                                <strong>Gastos elevados</strong><br>
                                <small>Tus gastos han aumentado un {{ "%.1f"|format(totales_comparativa.costos_porcentaje) }}% este mes vs el anterior</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Alerta de crecimiento positivo -->
                    {% if totales_comparativa and totales_comparativa.porcentaje_ganancia > 15 %}
                    <div class="col-md-6">
                        <div class="alert alert-success mb-0 d-flex align-items-center" role="alert">
                            <i class="bi bi-graph-up-arrow me-2"></i>
                            <div>
                                <strong>춰Excelente desempe침o!</strong><br>
                                <small>Tus ganancias crecieron {{ "%.1f"|format(totales_comparativa.porcentaje_ganancia) }}% este mes</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Alerta de tr치mites activos -->
                    {% if tramites_comparativa and tramites_comparativa.cambio > 5 %}
                    <div class="col-md-6">
                        <div class="alert alert-info mb-0 d-flex align-items-center" role="alert">
                            <i class="bi bi-activity me-2"></i>
                            <div>
                                <strong>Alta actividad hoy</strong><br>
                                <small>{{ tramites_comparativa.cambio }} tr치mites m치s que ayer</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Recordatorio de registro -->
                    {% if tramites_de_hoy == 0 %}
                    <div class="col-md-6">
                        <div class="alert alert-secondary mb-0 d-flex align-items-center" role="alert">
                            <i class="bi bi-clipboard-check me-2"></i>
                            <div>
                                <strong>Sin tr치mites hoy</strong><br>
                                <small>No has registrado tr치mites el d칤a de hoy</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Mensaje de Suplantaci칩n -->
{% if is_impersonating %}
<div class="alert alert-warning alert-dismissible fade show" role="alert">
    <i class="bi bi-eye"></i>
    <strong>Modo de Suplantaci칩n:</strong> Ahora est치s viendo la interfaz como <strong>{{ impersonated_user_name }}</strong>.
    <a href="{{ url_for('auth.stop_viewing') }}" class="btn btn-sm btn-outline-warning ms-2">
        <i class="bi bi-person-check"></i> Volver a Admin
    </a>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<!-- Estilos Apple/iPhone para gr치ficos -->
<style>
    .apple-card {
        background: var(--bs-body-bg);
        border-radius: 20px;
        border: none;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.04);
        overflow: hidden;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .apple-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12), 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    .apple-header {
        padding: 20px 24px;
        border-radius: 20px 20px 0 0;
        position: relative;
        overflow: hidden;
    }
    .apple-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: inherit;
        filter: blur(0);
        z-index: 0;
    }
    .apple-header-purple {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    }
    .apple-header-blue {
        background: linear-gradient(135deg, #00c6fb 0%, #005bea 50%, #00d4ff 100%);
    }
    .apple-header-content {
        position: relative;
        z-index: 1;
    }
    .apple-title {
        font-size: 1.1rem;
        font-weight: 700;
        letter-spacing: -0.02em;
        margin-bottom: 2px;
    }
    .apple-subtitle {
        font-size: 0.8rem;
        opacity: 0.85;
        font-weight: 500;
    }
    .apple-icon-btn {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .apple-icon-btn:hover {
        background: rgba(255, 255, 255, 0.4);
        transform: scale(1.05);
    }
    .apple-body {
        padding: 24px;
    }
    .apple-stat-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
        border-radius: 16px;
        padding: 16px;
        text-align: center;
        border: 1px solid rgba(0,0,0,0.04);
        backdrop-filter: blur(10px);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    [data-bs-theme="dark"] .apple-stat-card {
        background: linear-gradient(135deg, rgba(30,41,59,0.9) 0%, rgba(51,65,85,0.7) 100%);
        border-color: rgba(255,255,255,0.08);
    }
    .apple-stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }
    .apple-stat-card.green { border-left: 4px solid #34c759; }
    .apple-stat-card.red { border-left: 4px solid #ff3b30; }
    .apple-stat-card.blue { border-left: 4px solid #007aff; }
    .apple-stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-size: 1.2rem;
    }
    .apple-stat-icon.green { background: linear-gradient(135deg, #34c759, #30d158); color: white; }
    .apple-stat-icon.red { background: linear-gradient(135deg, #ff3b30, #ff453a); color: white; }
    .apple-stat-icon.blue { background: linear-gradient(135deg, #007aff, #0a84ff); color: white; }
    .apple-stat-label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        opacity: 0.7;
        margin-bottom: 4px;
    }
    .apple-stat-value {
        font-size: 1.5rem;
        font-weight: 800;
        letter-spacing: -0.03em;
        background: linear-gradient(135deg, var(--stat-color-1), var(--stat-color-2));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .apple-stat-card.green .apple-stat-value { --stat-color-1: #34c759; --stat-color-2: #30d158; }
    .apple-stat-card.red .apple-stat-value { --stat-color-1: #ff3b30; --stat-color-2: #ff453a; }
    .apple-stat-card.blue .apple-stat-value { --stat-color-1: #007aff; --stat-color-2: #0a84ff; }
    .apple-chart-container {
        position: relative;
        height: 380px;
        min-height: 340px;
        padding: 12px;
        border-radius: 16px;
        background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.02) 100%);
    }
    .apple-chart-container canvas {
        max-height: 100% !important;
    }
    [data-bs-theme="dark"] .apple-chart-container {
        background: linear-gradient(180deg, transparent 0%, rgba(255,255,255,0.02) 100%);
    }
    /* Animaci칩n de entrada suave */
    @keyframes appleSlideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .apple-card {
        animation: appleSlideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .row.g-4 .col-lg-6:nth-child(2) .apple-card {
        animation-delay: 0.1s;
    }
    /* Estado vac칤o estilo Apple */
    .apple-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--bs-secondary-color);
        padding: 40px 20px;
    }
    .apple-empty-icon {
        width: 80px;
        height: 80px;
        border-radius: 24px;
        background: linear-gradient(135deg, rgba(0,0,0,0.05), rgba(0,0,0,0.02));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        margin-bottom: 16px;
    }
    [data-bs-theme="dark"] .apple-empty-icon {
        background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
    }
    .apple-empty-text {
        font-size: 0.95rem;
        font-weight: 600;
        letter-spacing: -0.01em;
    }
</style>

<!-- Fila de Gr치ficos - Estilo Apple -->
<div class="row g-4 mb-4">
    <!-- Gr치fico 1: Top Papeler칤as por Ganancia -->
    <div class="col-lg-6">
        <div class="apple-card h-100">
            <div class="apple-header apple-header-purple text-white">
                <div class="apple-header-content d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="apple-title mb-0">
                            <i class="bi bi-trophy-fill me-2"></i>
                            Papeler칤as M치s Rentables
                        </h5>
                        <small class="apple-subtitle">Top 10 por ganancia generada</small>
                    </div>
                    <div class="d-flex gap-2">
                        <div class="apple-icon-btn" onclick="exportChartData('topPapelerias')" title="Exportar">
                            <i class="bi bi-arrow-down-circle"></i>
                        </div>
                        <div class="apple-icon-btn">
                            <i class="bi bi-bar-chart-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="apple-body">
                <div class="apple-chart-container">
                    <canvas id="topPapeleriasChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr치fico 2: Evoluci칩n Mensual -->
    <div class="col-lg-6">
        <div class="apple-card h-100">
            <div class="apple-header apple-header-blue text-white">
                <div class="apple-header-content d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="apple-title mb-0">
                            <i class="bi bi-graph-up-arrow me-2"></i>
                            Evoluci칩n Mensual
                        </h5>
                        <small class="apple-subtitle">Tendencia de los 칰ltimos 12 meses</small>
                    </div>
                    <div class="d-flex gap-2">
                        <div class="apple-icon-btn" onclick="exportChartData('monthlySummary')" title="Exportar">
                            <i class="bi bi-arrow-down-circle"></i>
                        </div>
                        <div class="apple-icon-btn">
                            <i class="bi bi-calendar3"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="apple-body">
                <!-- Tarjetas de resumen estilo Apple -->
                <div class="row g-3 mb-4">
                    <div class="col-4">
                        <div class="apple-stat-card green">
                            <div class="apple-stat-icon green">
                                <i class="bi bi-arrow-up-right"></i>
                            </div>
                            <div class="apple-stat-label">Ingresos</div>
                            <div class="apple-stat-value" id="total-ingresos-12-meses">$0</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="apple-stat-card red">
                            <div class="apple-stat-icon red">
                                <i class="bi bi-arrow-down-right"></i>
                            </div>
                            <div class="apple-stat-label">Gastos</div>
                            <div class="apple-stat-value" id="total-gastos-12-meses">$0</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="apple-stat-card blue">
                            <div class="apple-stat-icon blue">
                                <i class="bi bi-wallet2"></i>
                            </div>
                            <div class="apple-stat-label">Ganancia</div>
                            <div class="apple-stat-value" id="ganancia-neta-12-meses">$0</div>
                        </div>
                    </div>
                </div>
                <div class="apple-chart-container">
                    <canvas id="monthlySummaryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estilos adicionales Apple para gr치ficos de dona -->
<style>
    .apple-header-orange {
        background: linear-gradient(135deg, #ff9500 0%, #ff6b00 50%, #ffcc00 100%);
    }
    .apple-header-pink {
        background: linear-gradient(135deg, #ff2d55 0%, #ff375f 50%, #ff6b8a 100%);
    }
    .apple-donut-container {
        position: relative;
        height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>

<!-- Fila de Gr치ficos de Dona - Estilo Apple -->
<div class="row g-4 mb-4">
    <!-- Gr치fico 3: Distribuci칩n de Tr치mites -->
    <div class="col-lg-6">
        <div class="apple-card h-100">
            <div class="apple-header apple-header-orange text-white">
                <div class="apple-header-content d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="apple-title mb-0">
                            <i class="bi bi-file-earmark-check-fill me-2"></i>
                            Tr치mites M치s Realizados
                        </h5>
                        <small class="apple-subtitle">Distribuci칩n por tipo de documento</small>
                    </div>
                    <div class="d-flex gap-2">
                        <div class="apple-icon-btn" onclick="exportChartData('tramitesDistribution')" title="Exportar">
                            <i class="bi bi-arrow-down-circle"></i>
                        </div>
                        <div class="apple-icon-btn">
                            <i class="bi bi-pie-chart-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="apple-body">
                <div class="apple-donut-container">
                    <canvas id="tramitesDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr치fico 4: Distribuci칩n de Gastos -->
    <div class="col-lg-6">
        <div class="apple-card h-100">
            <div class="apple-header apple-header-pink text-white">
                <div class="apple-header-content d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="apple-title mb-0">
                            <i class="bi bi-credit-card-2-front-fill me-2"></i>
                            Distribuci칩n de Gastos
                        </h5>
                        <small class="apple-subtitle">쮼n qu칠 se gasta m치s dinero?</small>
                    </div>
                    <div class="d-flex gap-2">
                        <div class="apple-icon-btn" onclick="exportChartData('gastosDistribution')" title="Exportar">
                            <i class="bi bi-arrow-down-circle"></i>
                        </div>
                        <div class="apple-icon-btn">
                            <i class="bi bi-pie-chart-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="apple-body">
                <div class="apple-donut-container">
                    <canvas id="gastosDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>