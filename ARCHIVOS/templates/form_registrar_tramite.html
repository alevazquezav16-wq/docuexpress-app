<div id="registrar-tramite-container" 
     hx-trigger="refresh-papeleria-list from:body" 
     hx-get="{{ url_for('papeleria.get_tramite_form') }}" 
     hx-swap="innerHTML">

<!-- Toast de confirmación (oculto inicialmente) -->
<div id="tramite-success-toast" class="alert alert-success d-none mb-3 shadow-sm" role="alert">
	<div class="d-flex align-items-center">
		<div class="me-3" style="font-size: 1.75rem;">
			<i class="bi bi-check-circle-fill text-success"></i>
		</div>
		<div class="flex-grow-1">
			<strong class="d-block">¡Trámite registrado!</strong>
			<small class="text-muted">El formulario está listo para otro registro</small>
		</div>
		<button type="button" class="btn-close ms-2" onclick="this.closest('.alert').classList.add('d-none')" aria-label="Cerrar"></button>
	</div>
</div>

<form id="form-registrar-tramite"
		hx-post="{{ url_for('papeleria.registrar_tramite') }}"
		hx-target="#registrar-tramite-container"
		hx-swap="innerHTML">
	{% include 'form_tramite_fields.html' %}
	{{ form_tramite.hidden_tag() }}
	<div class="position-relative d-inline-block w-100">
		<button type="submit" id="btn-registrar-tramite" class="btn btn-primary w-100 btn-lg position-relative overflow-hidden">
			<span id="tramite-loading" class="d-none">
				<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
				Procesando...
			</span>
			<span id="tramite-btn-text"><i class="bi bi-plus-circle me-1"></i>Registrar Trámite</span>
		</button>
	</div>
</form>

<script>
(function() {
    // DELEGACIÓN DE EVENTOS: Registrar UNA SOLA VEZ en document.body
    // Usamos un flag para evitar registrar múltiples veces
    if (!window._tramiteListenersRegistered) {
        window._tramiteListenersRegistered = true;
        
        // Listener para ANTES de la request
        document.body.addEventListener('htmx:beforeRequest', function(evt) {
            // Solo actuar si el evento viene del form de trámites
            if (evt.detail.elt && evt.detail.elt.id === 'form-registrar-tramite') {
                console.log('[TRAMITE] beforeRequest disparado');
                var btn = document.getElementById('btn-registrar-tramite');
                var loading = document.getElementById('tramite-loading');
                var btnText = document.getElementById('tramite-btn-text');
                
                if (btn) {
                    btn.disabled = true;
                    btn.style.opacity = '0.7';
                    console.log('[TRAMITE] Botón deshabilitado');
                }
                if (loading) {
                    loading.classList.remove('d-none');
                    console.log('[TRAMITE] Spinner mostrado');
                }
                if (btnText) {
                    btnText.classList.add('d-none');
                    console.log('[TRAMITE] Texto ocultado');
                }
            }
        });
        
        // Listener para DESPUÉS de la request (en caso de error sin swap)
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.elt && evt.detail.elt.id === 'form-registrar-tramite') {
                console.log('[TRAMITE] afterRequest disparado, successful:', evt.detail.successful);
                // Solo restaurar si hubo error (el swap no ocurrió)
                if (!evt.detail.successful) {
                    var btn = document.getElementById('btn-registrar-tramite');
                    var loading = document.getElementById('tramite-loading');
                    var btnText = document.getElementById('tramite-btn-text');
                    
                    if (btn) btn.disabled = false;
                    if (btn) btn.style.opacity = '1';
                    if (loading) loading.classList.add('d-none');
                    if (btnText) btnText.classList.remove('d-none');
                }
            }
        });
        
        console.log('[TRAMITE] Listeners de delegación registrados en document.body');
    }
})();
</script>
</div>